----- CREACION Y USO DE LA BASE DE DATOS -----
CREATE DATABASE ServiEntrega2
GO
USE ServiEntrega2
GO
----- CREACION DE LAS TABLAS (NO INCLUYE LAS RELACIONES) -----
CREATE TABLE dbo.Ciudad
	(CodCiudad INT PRIMARY KEY NOT NULL,
	Nombre VARCHAR(30) NOT NULL,
	NumeroHab BIGINT NOT NULL)
GO
CREATE TABLE dbo.Sucursal
	(CodSucursal INT PRIMARY KEY NOT NULL,
	Nombre VARCHAR(30) NOT NULL,
	CodCiudad INT NOT NULL)
GO
CREATE TABLE dbo.Mensajero
	(Cedula BIGINT PRIMARY KEY NOT NULL,
	Nombre VARCHAR (30) NOT NULL,
	Edad INT NOT NULL,
	CodSucursal INT NOT NULL,
	Placa VARCHAR(7) NOT NULL)
GO
CREATE TABLE dbo.Paquete
	(Numero INT NOT NULL,
	Cedula_Mensajero BIGINT NOT NULL, 
	FechaEntrega DATE NOT NULL,
	TipoEmpaque VARCHAR(30) NOT NULL,
	Cedula_Destinatario BIGINT NOT NULL)
GO
CREATE TABLE dbo.Destinario
	(Cedula BIGINT PRIMARY KEY NOT NULL,
	Direccion VARCHAR(30) NOT NULL,
	Nombre VARCHAR(30) NOT NULL)
GO
CREATE TABLE dbo.Vehiculo
	(Placa VARCHAR(7) PRIMARY KEY NOT NULL,
	Marca VARCHAR(30) NOT NULL)
GO
CREATE TABLE dbo.Camion
	(Placa VARCHAR(7) PRIMARY KEY NOT NULL,
	Capacidad INT NOT NULL)
GO
CREATE TABLE dbo.Motocicleta
	(Placa VARCHAR(7) PRIMARY KEY NOT NULL,
	Cilindraje DECIMAL NOT NULL)
GO
CREATE TABLE dbo.Zona
	(CodZona INT PRIMARY KEY NOT NULL,
	Nombre VARCHAR(30) NOT NULL)
GO
CREATE TABLE dbo.Zona_Mensajero
	(CodZona INT NOT NULL,
	Cedula_Mensajero BIGINT NOT NULL,
	Kilometro DECIMAL NOT NULL)
GO
----- ALTERAR LAS TABLAS PARA RELACIONARLAS -----
ALTER TABLE dbo.Sucursal ADD FOREIGN KEY(CodCiudad) REFERENCES dbo.Ciudad(CodCiudad)
ALTER TABLE dbo.Mensajero ADD FOREIGN KEY(CodSucursal) REFERENCES dbo.Sucursal(CodSucursal)
ALTER TABLE dbo.Mensajero ADD FOREIGN KEY(Placa) REFERENCES dbo.Vehiculo(Placa)
ALTER TABLE dbo.Paquete ADD FOREIGN KEY(Cedula_Mensajero) REFERENCES dbo.Mensajero(Cedula)
ALTER TABLE dbo.Paquete ADD FOREIGN KEY(Cedula_Destinatario) REFERENCES dbo.Destinario(Cedula)
ALTER TABLE dbo.Motocicleta ADD FOREIGN KEY(Placa) REFERENCES dbo.Vehiculo(Placa)
ALTER TABLE dbo.Camion ADD FOREIGN KEY(Placa) REFERENCES dbo.Vehiculo(Placa)
ALTER TABLE dbo.Zona_Mensajero ADD FOREIGN KEY(CodZona) REFERENCES dbo.Zona(CodZona)
ALTER TABLE dbo.Zona_Mensajero ADD FOREIGN KEY(Cedula_Mensajero) REFERENCES dbo.Mensajero(Cedula)
GO
-- PROCEDIMIENTOS ALMACENADOS CRUD 
-- CRUD EN CIUDAD

CREATE PROCEDURE UPDATECIUDAD 
@CODCIUDAD INT,
@NOMBRE VARCHAR(30),
@NUMEROHAB BIGINT AS
BEGIN
UPDATE Ciudad 
SET  Nombre= @NOMBRE, 
     NumeroHab = @NUMEROHAB,
	 CodCiudad = @CODCIUDAD
END
GO
CREATE PROCEDURE INSTERTCIUDAD 
@CODCIUDAD INT,
@NOMBRE VARCHAR(30),
@NUMEROHAB BIGINT AS
BEGIN
INSERT INTO Ciudad(
	   Nombre,
	   NumeroHab,
	   CodCiudad)
    VALUES (
	   @CODCIUDAD,
	   @NOMBRE,
	   @NUMEROHAB)
END
GO
CREATE PROCEDURE DELETECIUDAD
@CODCIUDAD INT AS
BEGIN 

DELETE FROM Ciudad
WHERE CodCiudad = @CODCIUDAD 
END 
GO

-- CRUD EN SUCURSAL 

CREATE PROCEDURE UPDATESUCURSAL 
@CODSUCURSAL INT,
@NOMBRE VARCHAR(30) AS
BEGIN
UPDATE Sucursal 
SET  Nombre= @NOMBRE
WHERE CodSucursal= @CODSUCURSAL
END
GO
CREATE OR ALTER PROCEDURE INSTERTSUCURSAL
@CODSUCURSAL INT,
@NOMBRE VARCHAR(30),
@CODCIUDAD INT AS

BEGIN
INSERT INTO Sucursal(
	   CodSucursal,
	   Nombre,
	   CodCiudad)
    VALUES (
	   @CODSUCURSAL,
	   @NOMBRE,
	   @CODCIUDAD)
END
GO
CREATE PROCEDURE DELETESUCURSAL
@CODSUCURSAL INT AS
BEGIN 
DELETE FROM Sucursal
WHERE CodSucursal = @CODSUCURSAL
END 
GO
-- CRUD MENSAJERO 

CREATE PROCEDURE UPDATEMENSAJERO
@CEDULA BIGINT,
@NOMBRE VARCHAR(30),
@EDAD INT,
@CODIGOSUCURSAL INT,
@PLACA VARCHAR(7) AS
BEGIN
UPDATE Mensajero
SET  Nombre = @NOMBRE,
	 Edad = @EDAD,
	 CodSucursal= @CODIGOSUCURSAL,
	 Placa = @PLACA
WHERE Cedula= @CEDULA
END
GO
CREATE PROCEDURE INSTERTMENSAJERO
@CEDULA BIGINT,
@NOMBRE VARCHAR(30),
@EDAD INT,
@CODIGOSUCURSAL INT,
@PLACA VARCHAR(7) AS

BEGIN
INSERT INTO Mensajero(
	   Cedula,
	   Nombre,
	   Edad,
	   CodSucursal,
	   Placa
	   )
    VALUES (
	   @CEDULA,
	   @NOMBRE,
	   @EDAD,
	   @CODIGOSUCURSAL,
	   @PLACA)
END
GO
CREATE PROCEDURE DELETEMENSAJERO
@CEDULAMENSAJERO BIGINT AS
BEGIN 

DELETE FROM Mensajero
WHERE Cedula = @CEDULAMENSAJERO
END 
GO
-- CRUD ZONA MENSAJERO, TABLA DE RELACION MUCHOS A MUCHOS

CREATE PROCEDURE UPDATEZONAMENSAJERO
@CODIGOZONA INT,
@CEDULAMENSAJERO BIGINT,
@KILOMETRO INT AS
BEGIN
UPDATE Zona_Mensajero
SET  Kilometro = Kilometro
WHERE CodZona = @CODIGOZONA AND Cedula_Mensajero = @CEDULAMENSAJERO
END
GO
CREATE PROCEDURE INSTERTZONAMENSAJERO
@CODIGOZONA INT,
@CEDULAMENSAJERO BIGINT,
@KILOMETRO INT AS
BEGIN
INSERT INTO Zona_Mensajero(
	   CodZona,
	   Cedula_Mensajero,
	   Kilometro)
    VALUES (
	   @CODIGOZONA,
	   @CEDULAMENSAJERO,
	   @KILOMETRO)
END
GO
CREATE PROCEDURE DELETEZONAMENSAJERO_COD
@CODIGOZONA INT AS
BEGIN 

DELETE FROM Zona_Mensajero
WHERE CodZona = @CODIGOZONA 
END
GO
CREATE PROCEDURE DELETEZONAMENSAJERO_CED
@CEDULAMENSAJERO BIGINT AS
BEGIN 
DELETE FROM Zona_Mensajero
WHERE Cedula_Mensajero = @CEDULAMENSAJERO
END 
GO
--CRUD EN ZONA 

CREATE PROCEDURE UPDATEZONA
@CODZONA BIGINT,
@NOMBRE VARCHAR(30) AS
BEGIN
UPDATE Zona
SET  Nombre = @NOMBRE
WHERE CodZona = @CODZONA
END
GO
CREATE PROCEDURE INSTERTZONA
@CODIGO INT,
@NOMBRE VARCHAR(30) AS
BEGIN
INSERT INTO Zona(
	   CodZona,
	   Nombre)
    VALUES (
	   @CODIGO,
	   @NOMBRE)
END
GO

CREATE PROCEDURE DELETEZONA
@CODIGO INT AS
BEGIN 

DELETE FROM Zona
WHERE CodZona = @CODIGO
END 
GO
-- CRUD EN PAQUETE 

CREATE PROCEDURE UPDATEPAQUETE
@NUMERO INT,
@CEDULAMENSAJERO BIGINT,
@FECHAENTREGA DATE,
@TIPOEMPAQUE INT,
@CEDULADESTINATARIO BIGINT AS 
BEGIN
UPDATE Paquete
SET   FechaEntrega = @FECHAENTREGA,
	  TipoEmpaque = @TIPOEMPAQUE,
	  Cedula_Destinatario = @CEDULADESTINATARIO

WHERE Numero = @NUMERO AND Cedula_Mensajero = @CEDULAMENSAJERO
END
GO
CREATE PROCEDURE INSTERTPAQUETE
@NUMERO INT,
@CEDULAMENSAJERO BIGINT,
@FECHAENTREGA DATE,
@TIPOEMPAQUE INT,
@CEDULADESTINATARIO BIGINT AS 
BEGIN

INSERT INTO Paquete(
	  Numero,
	  Cedula_Mensajero,
	  FechaEntrega,
	  TipoEmpaque,
	  Cedula_Destinatario)
    VALUES (
	  @NUMERO,
	  @CEDULAMENSAJERO,
	  @FECHAENTREGA,
	  @TIPOEMPAQUE,
	  @CEDULADESTINATARIO)
END
GO
CREATE PROCEDURE DELETEPAQUETE
@NUMERO INT,
@CEDULAMENSAJERO BIGINT AS
BEGIN 

DELETE FROM Paquete
WHERE Numero = @NUMERO AND Cedula_Mensajero = @CEDULAMENSAJERO
END 
GO
-- CRUD EN DESTINATARIO 

CREATE PROCEDURE UPDATEDESTINATARIO
@CEDULA BIGINT,
@DIRECCION VARCHAR(30),
@NOMBRE VARCHAR(30) AS
BEGIN
UPDATE Destinario
SET  Direccion = @DIRECCION,
	 Nombre = @NOMBRE
WHERE Cedula = @CEDULA
END
GO
CREATE PROCEDURE INSTERTDESTINATARIO
@CEDULA BIGINT,
@DIRECCION VARCHAR(30),
@NOMBRE VARCHAR(30) AS
BEGIN
INSERT INTO Destinario(
	   Cedula,
	   Direccion,
	   Nombre)
    VALUES (
	 @CEDULA,
	 @DIRECCION,
	 @NOMBRE)
END
GO

CREATE PROCEDURE DELETEDESTINATARIO
@CEDULA INT AS
BEGIN 

DELETE FROM Destinario
WHERE Cedula = @CEDULA
END 
GO
-- CRUD EN VEHICULO 

CREATE PROCEDURE UPDATEVEHICULO
@PLACA BIGINT,
@MARCA VARCHAR(30) AS
BEGIN
UPDATE Vehiculo
SET  Marca = @MARCA
WHERE Placa = @PLACA
END
GO
CREATE PROCEDURE INSTERTVEHICULO
@PLACA BIGINT,
@MARCA VARCHAR(30) AS
BEGIN
INSERT INTO Vehiculo(
	   Placa,
	   Marca)
    VALUES (
	@PLACA,
	@MARCA)
END
GO

CREATE PROCEDURE DELETEVEHICULO
@PLACA INT AS
BEGIN 

DELETE FROM Vehiculo
WHERE Placa = @PLACA
END 
GO

--CRUD EN CAMION 
CREATE PROCEDURE UPDATECAMION
@PLACA BIGINT,
@CAPACIDAD INT AS
BEGIN
UPDATE Camion
SET  Capacidad = @CAPACIDAD
WHERE Placa = @PLACA
END
GO

CREATE PROCEDURE INSTERTCAMION
@PLACA BIGINT,
@CAPACIDAD INT AS
BEGIN
INSERT INTO Camion(
	   Placa,
	   Capacidad)
    VALUES (
	@PLACA,
	@CAPACIDAD)
END
GO

CREATE PROCEDURE DELETECAMION
@PLACA INT AS
BEGIN 

DELETE FROM Camion
WHERE Placa = @PLACA
END 
GO

--CRUD EN MOTOCICLETA

CREATE PROCEDURE UPDATEMOTOCICLETA
@PLACA BIGINT,
@CILINDRAJE INT AS
BEGIN
UPDATE Motocicleta
SET  Cilindraje = @CILINDRAJE
WHERE Placa = @PLACA
END
GO

CREATE PROCEDURE INSTERTMOTOCICLETA
@PLACA BIGINT,
@CILINDRAJE INT AS
BEGIN
INSERT INTO Motocicleta(
	   Placa,
	   Cilindraje)
    VALUES (
	@PLACA,
	@CILINDRAJE)
END
GO

CREATE PROCEDURE DELETEMOTOCICLETA
@PLACA INT AS
BEGIN 

DELETE FROM Motocicleta
WHERE Placa = @PLACA
END 
GO

--CONSULTAS 
-- CONSULTA 1 TRAE LA PLACA DE LOS VEHICULOS MANEJADOS POR UN MENSAJERO EN UNA ZONA DADA POR EL USUARIO

CREATE PROCEDURE CONSULTA1 @CODZONA INT AS
BEGIN TRY
SELECT V.PLACA,Z.NOMBRE 'NOMBRE ZONA', M.Cedula, M.Nombre 'NOMBRE MENSAJERO' 
FROM Vehiculo V INNER JOIN Mensajero M ON V.PLACA = M.PLACA INNER JOIN Zona_Mensajero ZM 
ON ZM.Cedula_Mensajero = M.Cedula INNER JOIN ZONA Z ON ZM.CodZona = Z.CodZona
WHERE Z.CodZona = @CODZONA
END TRY
BEGIN CATCH
PRINT '¡ERROR EN EL PROCESO!'
PRINT ERROR_MESSAGE()
END CATCH
GO
-- CONSULTAR LOS PAQUETES ENTREGADOS HASTA UNA FECHA, CON DATOS DEL DESTINATARIO QUE LO RECIBIO Y EL MENSAJERO QUE LO ENVIO 

CREATE PROCEDURE CONSULTA2 @FECHA VARCHAR(10) AS
BEGIN TRY
SELECT P.*,D.Nombre,D.Direccion
FROM Paquete P INNER JOIN Mensajero M ON P.Cedula_Mensajero = M.Cedula INNER JOIN Destinario D
ON P.Cedula_Destinatario = D.Cedula
WHERE FechaEntrega=@FECHA
END TRY
BEGIN CATCH
PRINT '¡ERROR EN EL PROCESO!'
PRINT ERROR_MESSAGE()
END CATCH
GO


-- CONSULTA MENSAJEROS QUE TRABAJAN EN UNA CIUDAD DETERMIANDA, SU ZONA Y SUCURSAL

CREATE PROCEDURE CONSULTA3 @CEDULA BIGINT AS
BEGIN TRY
SELECT M.Cedula,M.Nombre,M.Edad,C.NOMBRE 'CIUDAD',Z.NOMBRE'ZONA',S.Nombre 'SUCURSAL'
FROM Mensajero M INNER JOIN Zona_Mensajero ZM 
ON ZM.Cedula_Mensajero = M.Cedula INNER JOIN ZONA Z ON ZM.CodZona = Z.CodZona 
INNER JOIN Sucursal S ON M.CodSucursal= S.CodSucursal INNER JOIN Ciudad C ON 
S.CodCiudad= C.CodCiudad
WHERE M.Cedula = @CEDULA 
END TRY
BEGIN CATCH
PRINT '¡ERROR EN EL PROCESO!'
PRINT ERROR_MESSAGE()
END CATCH
GO
